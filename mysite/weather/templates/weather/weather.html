{% extends "base.html" %}
{% load static %}
{% block content %}
    <style>
        .chart-container {
            max-width: 1500px;
            margin: 20px auto;
            padding: 0 15px;
        }
    </style>
    <h1 style="text-align: center;">Weather Forecast Analysis</h1>
    <h4 style="text-align: center;">This is an analysis of <strong> {{ forecastcount }} </strong> weather forecasts.</h4>

    <div class="chart-container">
        <div id="hbc_container"></div>
    </div>

    <script>
    let hbc_chart = null;
    const hbc_series = {{ hbc_series|safe }};
    const hbc_categories = {{ hbc_categories|safe }};

    function renderHBCChart() {
      console.log("Rendering HBC chart...");
      if (hbc_chart) {
        hbc_chart.destroy();
      }
      hbc_chart = Highcharts.chart('hbc_container', {
        chart: {
          type: 'line'
        },
        title: {
          text: 'Average Difference Between Predicted and Actual Temp'
        },
        xAxis: {
          title: {
            text: 'Hours Before'
          },
          categories: hbc_categories
        },
        yAxis: {
          title: {
            text: 'Average Difference'
          },
          reversed: false
        },
        plotOptions: {
            line: {
                marker: {
                    enabled: false
                }
            }
        },
        series: hbc_series
      });
    }

    document.addEventListener('DOMContentLoaded', function () {
      console.log("DOMContentLoaded: Initializing HBC chart");
      applyHighchartsTheme();
      renderHBCChart();
    });

    // Listen for theme changes and redraw charts
    document.addEventListener('themeChanged', function(event) {
      console.log("themeChanged event received, redrawing HBC chart");
      applyHighchartsTheme();
      renderHBCChart();
    });
    </script>


    <div class="chart-container">
        <div id="ma_container"></div>
    </div>

        <div class="dropdown-container" style="text-align: center; margin-bottom: 20px;">
        <label for="hoursDropdown">Select Hours Before:</label>
        <select id="hoursDropdown">
            <option value="1">1 Hour</option>
            <option value="6">6 Hours</option>
            <option value="12" selected>12 Hours</option>
            <option value="24">24 Hours</option>
        </select>
    </div>

    <script>
    let ma_chart = null;
    const ma_series_original = {{ ma_series|safe }};
    const ma_categories_original = {{ ma_categories|safe }};
    let currentHoursBefore = 12;

    function updateChart(hoursbefore) {
        console.log("Updating MA chart with hoursbefore:", hoursbefore);
        currentHoursBefore = hoursbefore;

        const filteredSeries = ma_series_original.map(api => {
            return {
                name: api.name,
                data: api.data.filter(point => {
                    const category = ma_categories_original[point.x];
                    return category.includes(`${hoursbefore} hours before`);
                })
            };
        });

        try {
            const filteredCategories = ma_categories_original.filter(category =>
                category.includes(`${hoursbefore} hours before`)
            );

            const monthNames = filteredCategories.map(category =>
                category.split(' - ')[0]
            );

            const updatedSeries = filteredSeries.map(api => ({
                name: api.name,
                data: api.data.map((point, index) => ({
                    x: index,
                    y: point.y
                }))
            }));

            const ma_container = document.getElementById('ma_container');
            if (ma_chart) {
              ma_chart.destroy();
            }
            ma_chart = Highcharts.chart(ma_container, {
                chart: {
                    type: 'line'
                },
                title: {
                    text: `Average Difference by Month (${hoursbefore} ${hoursbefore === 1 ? 'Hour' : 'Hours'} Before)`
                },
                xAxis: {
                    title: {
                        text: 'Month'
                    },
                    categories: monthNames
                },
                yAxis: {
                    title: {
                        text: 'Average Difference'
                    },
                    reversed: false
                },
                series: updatedSeries
            });
            console.log("MA chart rendered successfully");
        } catch (error) {
            console.error("Error rendering MA chart:", error);
        }
    }

    document.addEventListener('DOMContentLoaded', function () {
        console.log("DOMContentLoaded: Initializing MA chart");
        
        const dropdown = document.getElementById('hoursDropdown');
        const ma_container = document.getElementById('ma_container');

        if (dropdown && ma_container) {
            updateChart(parseInt(dropdown.value));

            dropdown.addEventListener('change', function () {
                console.log("Dropdown value changed to:", this.value);
                updateChart(parseInt(this.value));
            });
        } else {
            console.error("MA Required elements not found:", {
                dropdown: !!dropdown,
                container: !!ma_container
            });
        }
    });

    // Listen for theme changes and redraw the chart with current selection
    document.addEventListener('themeChanged', function() {
        console.log("themeChanged event received, redrawing MA chart");
        updateChart(currentHoursBefore);
    });
    </script>
</main>
{% endblock %}