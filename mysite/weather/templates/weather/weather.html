{% load static %}
<!DOCTYPE html>
<html data-bs-theme="dark" lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
    <title>Benjamin B Bonnell</title>
    <link rel="icon" href="{% static 'assets/img/favicon.png' %}" type="image/png">
    <link rel="stylesheet" href="{% static 'assets/bootstrap/css/bootstrap.min.css' %}">
    <link rel="stylesheet" href="{% static 'assets/css/Navbar-Right-Links-Dark-icons.css' %}">
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script src="https://code.highcharts.com/modules/exporting.js"></script>
    <script src="https://code.highcharts.com/modules/export-data.js"></script>
    <script src="https://code.highcharts.com/modules/accessibility.js"></script>
    <script>
        // Global Highcharts configuration
        Highcharts.setOptions({
            credits: false,
            exporting: false
        });
    </script>
    <style>
        .chart-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 65vh;
        }
        #hbc_container {
            width: 75%;
            height: 400px;
        }
        #ma_container {
            width: 75%;
            height: 400px;
        }
        h1 {text-align: center;}
        h4 {text-align: center;}
    </style>
    <style>
        body {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .chart-container {
            flex: 1; /* Ensures the chart container takes up available space */
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-xl bg-dark py-3" data-bs-theme="dark">
        <div class="container">
            <a class="navbar-brand d-flex align-items-center" href="#">
                <span data-bs-toggle="tooltip" data-bss-tooltip="" style="font-weight: bold;" title="Because the URL didn't tell you whose site you were on.">Benjamin B Bonnell</span>
            </a>
            <button data-bs-toggle="collapse" class="navbar-toggler" data-bs-target="#navcol-5">
                <span class="visually-hidden">Toggle navigation</span>
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navcol-5">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item"><a class="nav-link" href="{% url 'weather:redirect_to_bensite_index' %}">Home</a></li>
                    <li class="nav-item"><a class="nav-link active" href="weather">Weather</a></li>
                    <li class="nav-item"><a class="nav-link" href="api">Weather API</a></li>
                    <li class="nav-item"><a class="nav-link" href="aboutsection">About</a></li>
                    <!-- Light/Dark Mode Toggle -->
                    <li class="nav-item dropdown">
                        <a class="nav-link" href="#" id="themeDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            <span class="navbar-toggler-icon"></span>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="themeDropdown">
                            <li class="dropdown-item">
                                <div class="d-flex justify-content-between align-items-center">
                                    <span>Dark Mode</span>
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="themeToggle" onchange="toggleTheme()">
                                        <label class="form-check-label" for="themeToggle"></label>
                                    </div>
                                </div>
                            </li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <h1>Weather Forecast Analysis</h1>
    <h4>This is an analysis of <strong> {{ forecastcount }} </strong> weather forecasts.</h4>

    <div class="chart-container">
        <div id="hbc_container"></div>
    </div>

    <script src="{% static 'assets/js/highcharts-theme.js' %}"></script>
    <script>
    document.addEventListener('DOMContentLoaded', function () {
      const hbc_series = {{ hbc_series|safe }};
      const hbc_categories = {{ hbc_categories|safe }};

      Highcharts.chart('hbc_container', {
        chart: {
          type: 'line'
        },
        title: {
          text: 'Average Difference Between Predicted and Actual Temp'
        },
        xAxis: {
          title: {
            text: 'Hours Before'
          },
          categories: hbc_categories
        },
        yAxis: {
          title: {
            text: 'Average Difference'
          },
          reversed: false
        },
        plotOptions: {
            line: {
                marker: {
                    enabled: false
                }
            }
        },
        series: hbc_series
      });
    });
    </script>


    <div class="chart-container">
        <div id="ma_container"></div>
    </div>

        <div class="dropdown-container" style="text-align: center; margin-bottom: 20px;">
        <label for="hoursDropdown">Select Hours Before:</label>
        <select id="hoursDropdown">
            <option value="1">1 Hour</option>
            <option value="6">6 Hours</option>
            <option value="12" selected>12 Hours</option>
            <option value="24">24 Hours</option>
        </select>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function () {
        console.log("DOMContentLoaded event fired");
        const ma_series_original = {{ ma_series|safe }};
        const ma_categories_original = {{ ma_categories|safe }};
        const dropdown = document.getElementById('hoursDropdown');
        const ma_container = document.getElementById('ma_container');

        console.log("Original Series:", ma_series_original);
        console.log("Original Categories:", ma_categories_original);
        console.log("Chart Container Dimensions:", ma_container ? ma_container.offsetWidth : 'not found', ma_container ? ma_container.offsetHeight : 'not found');
        console.log("Selected hours:", dropdown ? dropdown.value : 'dropdown not found');

        function updateChart(hoursbefore) {
            console.log("Updating chart with hoursbefore:", hoursbefore);

            // Filter the data points based on the hours before value in the category names
            const filteredSeries = ma_series_original.map(api => {
                console.log("Processing API:", api.name);
                return {
                    name: api.name,
                    data: api.data.filter(point => {
                        const category = ma_categories_original[point.x];
                        return category.includes(`${hoursbefore} hours before`);
                    })
                };
            });

            console.log("Filtered Series:", filteredSeries);

            try {
                // Filter categories to only show months for the selected hours
                const filteredCategories = ma_categories_original.filter(category =>
                    category.includes(`${hoursbefore} hours before`)
                );

                // Extract just the month names from the filtered categories
                const monthNames = filteredCategories.map(category =>
                    category.split(' - ')[0] // Take the part before " - "
                );

                // Update the data points to use sequential x values
                const updatedSeries = filteredSeries.map(api => ({
                    name: api.name,
                    data: api.data.map((point, index) => ({
                        x: index,
                        y: point.y
                    }))
                }));

                Highcharts.chart(ma_container, {
                    chart: {
                        type: 'line'
                    },
                    title: {
                        text: `Average Difference by Month (${hoursbefore} ${hoursbefore === 1 ? 'Hour' : 'Hours'} Before)`
                    },
                    xAxis: {
                        title: {
                            text: 'Month'
                        },
                        categories: monthNames
                    },
                    yAxis: {
                        title: {
                            text: 'Average Difference'
                        },
                        reversed: false
                    },
                    series: updatedSeries
                });
                console.log("Chart rendered successfully with filtered categories:", monthNames);
            } catch (error) {
                console.error("Error rendering chart:", error);
            }
        }

        // Initial chart rendering
        if (dropdown && ma_container) {
            updateChart(parseInt(dropdown.value));

            // Update chart when dropdown value changes
            dropdown.addEventListener('change', function () {
                console.log("Dropdown value changed to:", this.value);
                updateChart(parseInt(this.value));
            });
        } else {
            console.error("Required elements not found:", {
                dropdown: !!dropdown,
                container: !!ma_container
            });
        }
    });
    </script>

    <script src="{% static 'assets/bootstrap/js/bootstrap.bundle.min.js' %}"></script>
    <script src="{% static 'assets/js/bs-init.js' %}"></script>

    <script>
        // Function to toggle between light and dark modes
        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-bs-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-bs-theme', newTheme);
            // Optionally save the theme preference in localStorage
            localStorage.setItem('theme', newTheme);
        }

        // Apply the saved theme on page load
        document.addEventListener('DOMContentLoaded', function () {
            const savedTheme = localStorage.getItem('theme') || 'dark'; // Default to dark
            document.documentElement.setAttribute('data-bs-theme', savedTheme);
            document.getElementById('themeToggle').checked = savedTheme === 'dark';
        });
    </script>
    <footer class="text-center bg-dark text-light py-3 mt-4">
        <p>&copy; 2025 Benjamin B Bonnell.</p>
        <a href="https://github.com/benjaminbbonnell" class="text-light mx-2">GitHub</a>
        <a href="https://www.linkedin.com/in/benjaminbbonnell/" class="text-light mx-2">LinkedIn</a>
    </footer>
</body>

</html>